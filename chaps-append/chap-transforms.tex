\chapter{Reference Frame Transforms} \label{app:transforms}
    Reference frame transforms are defined by the shorthand \(\bm{x}\inrefframe{A}\transframe{A}{B}\), meaning vector \(\bm{x}\inrefframe{A}\) is transformed
    from reference frame \(\refframe{A}\) to \(\refframe{B}\). Reference frames used are the camera frame, \(\refframe{C}\),
    the map frame, \(\refframe{M}\), the local frame, \(\refframe{L}\), and the global frame, \(\refframe{G}\). Transforms used are
    descried in this appendix.

    \section{Camera to Map}
        Transforming a vector from camera,\ to map space requires rotating the vector by the camera quaternion, adding
        te camera's global position to the vector, scaling the vector into the map by multiplying with the map scaling
        factor, and finally modulating the vector to the confines of the map. As shown in equation \ref{eq:camera_to_map}.
        \begin{align} \label{eq:camera_to_map}
        \begin{split}
            \bm{x}\inrefframe{M} &= \bm{x}\inrefframe{C}\transframe{C}{M}\\ 
            &= (\bm{q}_\text{cam} \cdot \bm{x}\inrefframe{C} \cdot \bm{q}_\text{cam}^{-1}S + \bm{p_\text{rob}}\inrefframe{M}) \mod N
        \end{split}
        \end{align}
        where \(\bm{x}\inrefframe{C}\) is the vector in camera space, \(\bm{q}_\text{cam}\) is the camera quaternion that rotates \(\bm{x}\inrefframe{C}\) 
        into world space, with its \(z\) axis pointing upwards, \(\bm{p_\text{rob}}\inrefframe{M}\) is the coordinate vector of the robot in map space, and \(S\) is the scaling factor
        used to relate heightmap cells to cm. The relationship between \(N, S\) and \(E\) are characterised by equation \ref{eq:map_scaling}.
        \begin{equation} \label{eq:map_scaling}
            N = E \cdot S
        \end{equation}
        where \(E\times E\) is the size of the \(N\times N\) heightmap buffer in cm.
    
    \newpage
    \section{World to Map}
        The world to map transform is similar to camera to map tansform, except that the rotation is not required, as the map and world frames are already aligned.
        This is shown in equation \ref{eq:world_to_map}.
        \begin{align}\label{eq:world_to_map}
        \begin{split}
            \bm{x}\inrefframe{M} &= \bm{x}\inrefframe{W} \transframe{W}{M} \\
            &= \bm{x}\inrefframe{W}S \mod{N}
        \end{split}
        \end{align}
        where \(S\) is the scaling factor used to relate heightmap cells to cm, and the heightmap buffer is of size \(N\times N\).
    \section{Local to Map}
        Local to map space is very similar to equation \ref{eq:world_to_map}, with the exception of using the body quaternion instead of the camera quaterion. This can be seen in
        equation \ref{eq:local_to_map}.
        \begin{equation} \label{eq:local_to_map}
            \bm{x}\inrefframe{M} = (\bm{q_\text{bod}} \cdot \bm{x}\inrefframe{L} \cdot \bm{q_\text{bod}}^{-1}S + \bm{p_\text{rob}}\inrefframe{M}) \mod N
        \end{equation}
        where \(\bm{x}\inrefframe{L}\) is the vector in local space, \(\bm{q}_\text{bod}\) is the robot body's quaternion that rotates \(\bm{x}\inrefframe{L}\) 
        into map space, with its \(z\) axis pointing upwards, \(\bm{p_\text{rob}}\inrefframe{M}\) is the coordinate vector of the robot in map space, and \(S\) is the scaling factor
        used to relate heightmap cells to cm.

    \section{Map to Local}
        Due to the circular nature of the map buffer, translating from map to local space is more challenging. First an intermediate position, \(\bm{x_\text{temp}}\), is defined as a helper,
        \begin{equation} \label{eq:map_to_local_help}
            \bm{x_\text{temp}} = \bm{p_\text{rob}}\inrefframe{M}\frac{1}{S}
        \end{equation}
        where \(\bm{x_\text{temp}}\) is the map coordinates with the inverse map scaling applied. Now \(\bm{x_\text{temp}}\) must be checked to see if either of its 
        coordinates exceed half the map extents, if so, then it must be adjusted such that both coordinates fall within \(\frac{1}{2}E\).
        This is expressed in equation \ref{eq:map_to_local_adj}
        \begin{equation} \label{eq:map_to_local_adj}
            \bm{x_\text{temp}} \Leftarrow 
            \begin{cases}
                \bm{x_\text{temp}} & \bm{x_\text{temp}} \leq \frac{1}{2}E \\
                \bm{x_\text{temp}} - E(\sgn \bm{x_\text{temp}}) & \bm{x_\text{temp}} > \frac{1}{2}E
            \end{cases}
        \end{equation}
        where \(\sgn\) is the signum function, which return either 1 or -1 depending on the sign of the operand. 
        \textbf{Note} that equation \ref{eq:map_to_local_adj} is applied to both coordinates in the vector \(\bm{x_\text{temp}}\) separately, in pursuit of readability this is not explicitly stated.

        Now that \(\bm{x_\text{temp}}\) has been corrected for the circular nature of the map buffer, only the rotating into the local space remains. As show in equation \ref{eq:map_to_local_rot}.
        \begin{align} \label{eq:map_to_local_rot}
        \begin{split}
            \bm{x}\inrefframe{L} &= \bm{x}\inrefframe{M} \transframe{M}{L} \\
            &= \bm{q_\text{bod}}^{-1} \cdot \bm{x_\text{temp}} \cdot \bm{q_\text{bod}}
        \end{split}
        \end{align}
        where \(\bm{q}_\text{bod}\) is the robot body's quaternion.